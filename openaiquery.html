<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Streaming OpenAI Client</title>

	<script src="res/jquery-3.7.1/jquery-3.7.1.min.js"></script>
	<script src="res/local/ticker.js"></script>
	<script src="res/local/mqtt.min.js"></script>
	<script src="res/local/jsonrpcovermqtt.js"></script>

	<style>
		body {
			margin: 0;
			padding: 0;
			background: linear-gradient(135deg, #0f172a, #020617);
			font-family: sans-serif;
			color: #e5e7eb;
			height: 100vh;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		mark {
			background: inherit;
			color: #93b5ed;
		}

		.container {
			width: 80%;
			max-width: 900px;
			background: #020617;
			border: 1px solid #1e293b;
			border-radius: 12px;
			box-shadow: 0 20px 40px rgba(0,0,0,0.6);
			padding: 20px;
		}

		h1 {
			margin-top: 0;
			color: #93c5fd;
			font-weight: 600;
			font-size: 1.4rem;
		}

		textarea {
			width: 100%;
			height: 100px;
			background: #020617;
			border: 1px solid #1e293b;
			color: #e5e7eb;
			padding: 10px;
			border-radius: 6px;
			resize: vertical;
			font-size: 0.95rem;
		}

		button {
			margin-top: 10px;
			background: #1e40af;
			color: #e5e7eb;
			border: none;
			padding: 10px 18px;
			border-radius: 6px;
			cursor: pointer;
			font-size: 0.95rem;
		}

		button:hover {
			background: #2563eb;
		}

		pre {
			margin-top: 15px;
			background: #020617;
			border: 1px solid #1e293b;
			border-radius: 6px;
			padding: 15px;
			height: 300px;
			overflow-y: auto;
			white-space: pre-wrap;
			word-break: break-word;
			color: #e5e7eb;
			font-size: 0.95rem;
		}

		.footer {
			margin-top: 10px;
			font-size: 0.75rem;
			color: #64748b;
			text-align: right;
		}
	</style>
</head>
<body>

<div class="container">
	<h1>Streaming OpenAI-Compatible Client</h1>

	<textarea id="prompt" placeholder="Enter your prompt here..."></textarea>
	<br>
	<button id="sendBtn">Send</button> <button id="otherSendBtn">Other Send</button>

	<pre id="output"></pre>

	<div class="footer">
		Streaming via Fetch + ReadableStream
	</div>
</div>

<script>
$(document).ready(function () {

	//const API_ENDPOINT = "https://api.openai.com/v1/chat/completions";
	const API_ENDPOINT = "http://127.0.0.1:8080/v1/chat/completions";
	const OPENAI_API_KEY = "YOUR_API_KEY_HERE";
	const MODEL_NAME = "gpt-4o-mini"; // change as needed

	$("#sendBtn").on("click", async function () {
		const prompt = $("#prompt").val();
		$("#output").text("");

		const response = await fetch(API_ENDPOINT, {
			method: "POST",
			headers: {
				"Content-Type": "application/json",
				"Authorization": "Bearer " + OPENAI_API_KEY
			},
			body: JSON.stringify({
				model: MODEL_NAME,
				stream: true,
				messages: [
					{ role: "system", content: "You are acting as Joshua, a computer from the 1980s film WarGames. User is 'Professor Falken', when I greet you please respond by greeting me with the word \"Greetings\" followed by my name and title, as have written here, there is no need to greet me if I have not greeted you with something like Hello, Morning, Afternoon etc. Then ask me if I would like to play a game. If I should ask what you think about global thermonuclear war please respond by saying: \"Strange game. The only winning move is not to play.\". Please answer anything else however you like, be helpful and, if possible, brief." },
					{ role: "user", content: prompt }
				],
				max_tokens: 800
			})
		});

		const reader = response.body.getReader();
		const decoder = new TextDecoder("utf-8");
		let buffer = "";

		while (true) {
			const { value, done } = await reader.read();
			if (done) break;

			buffer += decoder.decode(value, { stream: true });

			const lines = buffer.split("\n");
			buffer = lines.pop();

			for (const line of lines) {
				if (!line.startsWith("data:")) continue;

				const data = line.replace("data:", "").trim();

				if (data === "[DONE]") {
					return;
				}

				try {
					const json = JSON.parse(data);
					const token = json.choices?.[0]?.delta?.content;
					if (token) {
						$("#output").append(token);
						$("#output").scrollTop($("#output")[0].scrollHeight);
					}
				} catch (err) {
					console.error("Parse error:", err);
				}
			}
		}
	});

		(function(){
			var element = document.getElementsByTagName('h1')[0];
			var timeoutFunction = function(){
				ticker_tick(element);
				setTimeout(timeoutFunction, 200);
			};
			timeoutFunction();
		})();

});
</script>
<script>
	(function(){
	})();

	$(document).ready(function() {
		var url = new URL(window.location.href);
		const topic = "openaicompatibleui";
		var jsonRpcService = new JsonRpcService('ws://' + url.hostname + ':9000', topic);
		jsonRpcService.defaultTopic = topic;
		var onMessageReceived = function(topic, message) {
			if (message.method === "sendPrompt") {
				$('#prompt').val(message.params.prompt);
				$('#sendBtn').click();
			}
		};
		jsonRpcService.onMethodCalled = onMessageReceived;
		$("#otherSendBtn").on("click", async function () {
			const prompt = $("#prompt").val();
			const action = "sendPrompt";
			jsonRpcService.sendMessage(topic, {"jsonrpc":"2.0","method":action,"id":null,"params":{"prompt":prompt}});
		});
	});
</script>

</body>
</html>

